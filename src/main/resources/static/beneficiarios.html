<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Beneficiarios</title>
    <link rel="stylesheet" href="./style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="css-body">
    <div class="css-container">
        <h2 class="css-title2">Gestión de Beneficiarios</h2>
        <div id="mensaje" class="alert css-alert" style="display:none;"></div>
        <form id="formBeneficiario" class="mb-4">
            <div class="row">
                <div class="col">
                    <input type="text" id="rut" class="form-control" placeholder="RUT" required>
                </div>
                <div class="col">
                    <input type="text" id="nombre" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col">
                    <input type="text" id="apellido" class="form-control" placeholder="Apellido" required>
                </div>
                <div class="col">
                    <input type="date" id="fechaNacimiento" class="form-control" placeholder="Fecha Nacimiento"
                        required>
                </div>
                <div class="col">
                    <select id="sexo" class="form-select" required>
                        <option value="">Sexo</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <input type="text" id="direccion" class="form-control" placeholder="Dirección" required>
                </div>
                <div class="col">
                    <input type="text" id="comuna" class="form-control" placeholder="Comuna" required>
                </div>
                <div class="col">
                    <input type="text" id="telefono" class="form-control" placeholder="Teléfono">
                </div>
                <div class="col">
                    <input type="email" id="correo" class="form-control" placeholder="Correo">
                </div>
                <div class="col">
                    <input type="text" id="numeroDocumento" class="form-control" placeholder="N° Documento" required>
                </div>
                <div class="col">
                    <select id="tipoDocumento" class="form-select" required>
                        <option value="">Tipo Documento</option>
                        <option value="DNI">RUT</option>
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary css-btn mt-3">Registrar</button>
        </form>

        <h3 class="css-title2">Lista de Beneficiarios</h3>
        <div id="tablaBeneficiarios"></div>

        <div id="historialModal" class="modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Historial del Beneficiario</h5>
                        <button type="button" class="btn-close" onclick="cerrarModal()"></button>
                    </div>
                    <div class="modal-body" id="historialContenido"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function cargarBeneficiarios() {
            const res = await fetch("/api/beneficiarios");
            const beneficiarios = await res.json();
            let html = `<table class="table table-striped"><thead>
        <tr>
            <th>RUT</th><th>Nombre</th><th>Apellido</th><th>Fecha Nac.</th>
            <th>Sexo</th><th>Dirección</th><th>Comuna</th><th>Teléfono</th>
            <th>Correo</th><th>Tipo Doc</th><th>N° Doc</th><th>Acciones</th>
        </tr></thead><tbody>`;
            for (const b of beneficiarios) {
                html += `<tr>
            <td>${b.rut}</td>
            <td>${b.nombre}</td>
            <td>${b.apellido}</td>
            <td>${b.fechaNacimiento || ''}</td>
            <td>${b.sexo || ''}</td>
            <td>${b.direccion || ''}</td>
            <td>${b.comuna || ''}</td>
            <td>${b.telefono || ''}</td>
            <td>${b.correo || ''}</td>
            <td>${b.tipoDocumento || ''}</td>
            <td>${b.numeroDocumento || ''}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="verHistorial('${b.rut}')">Historial</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarBeneficiario('${b.rut}')">Eliminar</button>
            </td>
        </tr>`;
            }
            html += "</tbody></table>";
            document.getElementById("tablaBeneficiarios").innerHTML = html;
        }

        document.getElementById("formBeneficiario").addEventListener("submit", async function (e) {
            e.preventDefault();
            const data = {
                rut: document.getElementById("rut").value,
                nombre: document.getElementById("nombre").value,
                apellido: document.getElementById("apellido").value,
                fechaNacimiento: document.getElementById("fechaNacimiento").value,
                sexo: document.getElementById("sexo").value,
                direccion: document.getElementById("direccion").value,
                comuna: document.getElementById("comuna").value,
                telefono: document.getElementById("telefono").value,
                correo: document.getElementById("correo").value,
                numeroDocumento: document.getElementById("numeroDocumento").value,
                tipoDocumento: document.getElementById("tipoDocumento").value
            };
            const res = await fetch("/api/beneficiarios", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                mostrarMensaje("Beneficiario registrado exitosamente", "green");
                this.reset();
                cargarBeneficiarios();
            } else {
                mostrarMensaje("Error al registrar beneficiario", "red");
            }
        });

        async function eliminarBeneficiario(rut) {
            if (!confirm("¿Seguro que deseas eliminar este beneficiario?")) return;
            const res = await fetch(`/api/beneficiarios/${rut}`, { method: "DELETE" });
            if (res.ok) {
                mostrarMensaje("Beneficiario eliminado", "green");
                cargarBeneficiarios();
            } else {
                mostrarMensaje("Error al eliminar beneficiario", "red");
            }
        }

        async function verHistorial(rut) {
            const res = await fetch(`/api/historial-pacientes/beneficiario/${rut}`);
            const historial = await res.json();
            let html = "";
            if (historial.length === 0) {
                html = "<p>No hay historial para este beneficiario.</p>";
            } else {
                html = `<table class="table"><thead>
            <tr><th>ID</th><th>Datos</th><th>Fecha Registro</th></tr>
            </thead><tbody>`;
                for (const h of historial) {
                    html += `<tr>
                <td>${h.id}</td>
                <td>${h.datosHistorial || ''}</td>
                <td>${h.fechaRegistro || ''}</td>
            </tr>`;
                }
                html += "</tbody></table>";
            }
            document.getElementById("historialContenido").innerHTML = html;
            document.getElementById("historialModal").style.display = "block";
        }

        function cerrarModal() {
            document.getElementById("historialModal").style.display = "none";
        }

        function mostrarMensaje(msg, color) {
            const el = document.getElementById("mensaje");
            el.textContent = msg;
            el.style.display = msg ? "block" : "none";
            el.style.color = color || "black";
        }

        window.onclick = function (event) {
            const modal = document.getElementById("historialModal");
            if (event.target === modal) {
                cerrarModal();
            }
        };

        cargarBeneficiarios();
    </script>
</body>

</html>