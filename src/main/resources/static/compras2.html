<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registrar Compra</title>
  <link rel="stylesheet" href="./style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="css-body">
  <div class="container my-5">
    <div class="css-container">
      <h2 class="css-title2">Nueva Compra</h2>
      <form id="compraForm">
        <div class="mb-3">
          <label for="fechaCompra" class="form-label">Fecha de Compra</label>
          <input type="date" id="fechaCompra" class="form-control" required />
        </div>

        <div class="mb-3">
          <label for="bodega" class="form-label">Bodega de Destino</label>
          <input type="text" id="bodega" class="form-control" placeholder="Ej. Central, Sucursal 1" required />
        </div>

        <h5>Productos en esta compra</h5>
        <table class="table table-bordered" id="tablaProductosCompra">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>Precio Compra</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="productosBody"></tbody>
        </table>

        <button type="button" class="btn btn-secondary mb-3" onclick="agregarFila()">+ Agregar Producto</button>
        <button type="submit" class="btn btn-primary w-100">Registrar Compra</button>
      </form>

      <div id="mensaje" class="css-alert mt-3"></div>
    </div>
  </div>

  <script>
    function agregarFila() {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td><input type="text" class="form-control" name="codigo" required /></td>
        <td><input type="text" class="form-control" name="nombre" required /></td>
        <td><input type="number" class="form-control" name="cantidad" min="1" required /></td>
        <td><input type="number" class="form-control" name="precio" min="0" step="0.01" required /></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">Eliminar</button></td>
      `;
      document.getElementById("productosBody").appendChild(fila);
    }

    document.getElementById("compraForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const fechaCompra = document.getElementById("fechaCompra").value;
      const bodega = document.getElementById("bodega").value;
      const filas = document.querySelectorAll("#productosBody tr");

      const detalles = Array.from(filas).map(fila => {
        return {
          codigo: fila.querySelector('[name="codigo"]').value,
          nombre: fila.querySelector('[name="nombre"]').value,
          cantidad: parseInt(fila.querySelector('[name="cantidad"]').value),
          precioCompra: parseFloat(fila.querySelector('[name="precio"]').value)
        };
      });

      const payload = {
        fecha: fechaCompra,
        bodega: bodega,
        detalles: detalles
      };

      const res = await fetch("/api/compras", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const msg = document.getElementById("mensaje");
      if (res.ok) {
        msg.textContent = "✔ Compra registrada correctamente.";
        msg.style.color = "green";
        this.reset();
        document.getElementById("productosBody").innerHTML = "";
      } else {
        msg.textContent = "⚠ Error al registrar la compra.";
        msg.style.color = "red";
      }
    });
  </script>
</body>
</html>
